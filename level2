#include <iostream>
#include <fstream>
#include <string>
#include <conio.h>
#include <chrono>
using namespace std;
using namespace std::chrono;

// Fungsi untuk mendapatkan waktu saat ini dalam milidetik
long long currentTime(){
    return duration_cast<milliseconds>(system_clock::now().time_since_epoch()).count();
}

// Struktur untuk posisi
struct position{
    int y, x;
};

// Struktur entitas (player dan objek game)
struct entitas {
    int x, y;
    string simbol;
    bool bawakunci;
};

// Struktur anomali dengan patrol route
struct anomali{
    int x, y;
    bool active;

    position route[200];   
    int routeSize;
    int routeIndex;
    bool move;

    long long lastMoveTime;
    long long speed;
    
    string anomaliSymbol;
};

const int Max_Y = 100;
const int Max_X = 100;
const int MAX_ANOMALI = 10; // Maksimum jumlah anomali

char map[Max_X][Max_Y];
int X = 0;
int Y = 0;

// Fungsi untuk menginisialisasi anomali
void initiateAnomali(anomali &a, position route[], int routeSize, long long speed, string symbol){
    a.routeSize = routeSize;
    for (int i = 0; i < routeSize; i++) {
        a.route[i] = route[i];
    }
    
    a.y = route[0].y;
    a.x = route[0].x;

    a.routeIndex = 0;
    a.move = true;

    a.lastMoveTime = currentTime();
    a.speed = speed;
    a.anomaliSymbol = symbol;
    a.active = true;
}

// Fungsi untuk menggerakkan anomali
void moveAnomali(anomali &a, long long currentT){
    if (!a.active) return;

    long long deltaT = currentT - a.lastMoveTime;
    if (deltaT < a.speed) return;

    if (a.move == true){
        a.routeIndex++;
        if (a.routeIndex == a.routeSize - 1) {
            a.move = false;
        }
    } else {
        a.routeIndex--;
        if (a.routeIndex == 0) {
            a.move = true;
        }
    }
    a.y = a.route[a.routeIndex].y;
    a.x = a.route[a.routeIndex].x;

    a.lastMoveTime = currentT;
}

// Fungsi membaca file map
void bacaFilemap(string namaFile, entitas &player){
    ifstream file(namaFile.c_str());
    if (!file.is_open()) {
        cout << "Error: File " << namaFile << " tidak ditemukan!" << endl;
        exit(1);
    }
    string line;
    while (getline(file, line) && X < Max_X){
        for(int i = 0; i < line.length() && i < Max_Y; i++){
            map[X][i] = line[i];
            if (map[X][i] == 'R' || map[X][i] == 'S' || map[X][i] == 'T') {
                map[X][i] = ' ';
            }
            if (map[X][i] == 'O') {
                player.x = i;
                player.y = X;
                map[X][i] = ' ';
            } else if (map[X][i] == 'A') {
                // Hapus marker anomali dari map
                map[X][i] = ' ';
            }
        }
        if (line.length() > Y) {
            Y = line.length();
        }
        X++;
    }
    file.close();
}

// Fungsi menampilkan map dengan multiple anomali
void tampilkanmap(entitas player, anomali anomaliList[], int jumlahAnomali) {
    for (int i = 0; i < X; i++) {
        for (int j = 0; j < Y; j++) {
            bool anomaliDitemukan = false;
            
            // Cek apakah ada anomali di posisi ini
            for (int k = 0; k < jumlahAnomali; k++) {
                if (anomaliList[k].active && i == anomaliList[k].y && j == anomaliList[k].x) {
                    cout << anomaliList[k].anomaliSymbol;
                    anomaliDitemukan = true;
                    break;
                }
            }
            
            if (!anomaliDitemukan) {
                if (i == player.y && j == player.x){
                    cout << player.simbol;
                } else {
                    cout << map[i][j];
                }
            }
        }
        cout << endl;
    }
}

// Fungsi cek collision dengan semua anomali
bool cekCollisionAnomali(entitas &player, anomali anomaliList[], int jumlahAnomali, int &nyawa, bool &game_berjalan, bool &menang){
    for (int i = 0; i < jumlahAnomali; i++) {
        if (anomaliList[i].active && player.x == anomaliList[i].x && player.y == anomaliList[i].y) {
            nyawa--;
            if (nyawa > 0){
                player.x = 0;
                player.y = 1;
                return true;
            } else {
                game_berjalan = false;
                menang = false;
                return true;
            }
        }
    }
    return false;
}

// Fungsi gerakan player
void gerakanplayer(entitas &player, anomali anomaliList[], int jumlahAnomali, bool &game_berjalan, bool &menang, int &nyawa, char input){
    int dx = 0;
    int dy = 0;
    
    switch (input){
        case 'w': 
        case 'W': 
            dy = -1; 
            break;
        case 's': 
        case 'S': 
            dy = 1; 
            break;
        case 'a': 
        case 'A': 
            dx = -2; 
            break;
        case 'd': 
        case 'D': 
            dx = 2; 
            break;
    }
    
    int Xsetelah = player.x + dx;
    int Ysetelah = player.y + dy;
    
    if (map[Ysetelah][Xsetelah] == '+' || map[Ysetelah][Xsetelah] == '-' || map[Ysetelah][Xsetelah] == '|'){
        return;
    }
    
    char pemain = map[Ysetelah][Xsetelah];
    if (pemain == 'K'){
        player.bawakunci = true;
        map[Ysetelah][Xsetelah] = ' ';
    }
    if (pemain == 'E'){
        if(player.bawakunci){
            menang = true;
            game_berjalan = false;
        }
    }
    
    // Cek tabrakan dengan semua anomali
    for (int i = 0; i < jumlahAnomali; i++) {
        if (Xsetelah == anomaliList[i].x && Ysetelah == anomaliList[i].y) {
            nyawa--;
            if (nyawa > 0){
                player.x = 0;
                player.y = 1;
                return;
            } else {
                game_berjalan = false;
                menang = false;    
                return;
            }    
        }
    }
    
    player.x = Xsetelah;
    player.y = Ysetelah;
}

// Fungsi menampilkan HUD
void tampilkanHUD(int nyawa, bool bawakunci, entitas player) {
    cout << "   +-----------------------------+--------------+\n";
    cout << "   |     L A B I R I N   G A M E |  NYAWA : ";
    cout << nyawa;
    cout << "  |\n";
    cout << "   +-----------------------------+--------------+\n";
    cout << "   | KUNCI : " 
         << (bawakunci ? "V" : "X")
         << "   | POS : (" << player.x << ", " << player.y << ")";
    
    int panjang = 12 + (bawakunci ? 1 : 1) + 12;
    for (int i = panjang; i < 43; i++) {
        cout << " ";
    }
    
    cout << "|\n";
    cout << "   +-------------------------------------------+\n\n";
}

int main(){
    char input;
    entitas player;
    player.x = 2;
    player.y = 1;
    player.simbol = 'O';
    player.bawakunci = false;
    
    int nyawa = 2;

    // Setup routes untuk 3 anomali
    position routeA1[] = {
        {2,43}, {2,41}, {2,39}, {2,37}, {2,35}, {2,33}, {2,31}, {2,29}, 
        {2,27}, {2,25}, {2,23}, {2,21}, {2,19}, {2,17}, {2,15}, {2,13}, 
        {2,11}, {3,11}, {4,11}, {5,11}, {6,11}, {6,9}, {6,7}, {7,7}, 
        {8,7}, {8,9}, {8,11}, {8,13}, {8,15}, {8,17}, {8,19}, {8,21}, 
        {8,23}
    };

    position routeA2[] = {
        {12,3}, {12,5}, {12,7}, {12,9}, {12,11}, {12,13}, {12,15}, {12,17}, 
        {12,19}, {13,19}, {14,19}, {14,21}, {14,23}, {13,23}, {12,23}, {12,25}, 
        {12,27}, {13,27}, {14,27}, {14,29}, {14,31}, {14,33}, {14,35}
    };


    // Array anomali
    anomali anomaliList[3];
    int jumlahAnomali = 3;
    
    // Inisialisasi setiap anomali dengan route dan kecepatan berbeda
    initiateAnomali(anomaliList[0], routeA1, sizeof(routeA1)/sizeof(routeA1[0]), 50 u8"∫");
    initiateAnomali(anomaliList[1], routeA2, sizeof(routeA2)/sizeof(routeA2[0]), 50, u8"∫");
    initiateAnomali(anomaliList[2], routeA3, sizeof(routeA3)/sizeof(routeA3[0]), 50, u8"∫");

    bacaFilemap("level2.txt", player);

    bool game_berjalan = true;
    bool menang = false;

    while (game_berjalan) {
        system("cls");
        
        // Update posisi semua anomali berdasarkan waktu
        for (int i = 0; i < jumlahAnomali; i++) {
            moveAnomali(anomaliList[i], currentTime());
        }
        
        // Cek collision dengan semua anomali setelah mereka bergerak
        cekCollisionAnomali(player, anomaliList, jumlahAnomali, nyawa, game_berjalan, menang);
        
        tampilkanmap(player, anomaliList, jumlahAnomali);
        tampilkanHUD(nyawa, player.bawakunci, player);
        
        input = _getch();
        gerakanplayer(player, anomaliList, jumlahAnomali, game_berjalan, menang, nyawa, input);
    }
    
    system("cls");
    if (menang) {
        cout << "\n==================================\n";
        cout << " SELAMAT! KAMU BERHASIL KELUAR! \n";
        cout << "==================================\n";
    } else {
        cout << "\n==================================\n";
        cout << " GAME OVER! KAMU TERTANGKAP ANOMALI \n";
        cout << "==================================\n";
    }
    return 0;
}
